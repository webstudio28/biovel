---
layout: base.njk
pagination:
    data: products
    size: 1
    alias: product
permalink: "/produkti/{{ product.meta_title }}/"
eleventyComputed:
    title: "{{ product.title }}"
    description: "{{ product.short_description }}"
---

<section class="py-6 bg-primary-sand/30">
    <div class="max-w-7xl w-full mx-auto px-4">
        <!-- Title Container - Above images on mobile/tablet -->
        <div class="mb-2 md:hidden">
            <h1 class="text-xl text-center md:text-3xl font-bold text-primary-evergreen">{{ product.title }}</h1>
        </div>
        
        <div class="flex flex-col md:flex-row gap-8 md:gap-12 md:items-stretch">
            
            <!-- Product Images Carousel Container -->
            <div class="w-full md:w-1/2 md:flex md:flex-col md:order-1">
                <div class="flex flex-col gap-4 justify-center items-center md:h-full">
                    <!-- Main Image -->
                    {% if product.images and product.images.length > 0 %}
                        <div class="bg-white rounded-2xl shadow-md aspect-square overflow-hidden w-full h-full ">
                            <img id="product-main-image" src="{{ product.images[0] | url }}" alt="{{ product.title }}" class="w-full h-full object-cover transition-opacity duration-300">
                        </div>
                        
                        <!-- Thumbnails -->
                        {% if product.images.length > 1 %}
                            <div class="flex flex-wrap gap-3 justify-center">
                                {% for image in product.images %}
                                    {% if image %}
                                        <button class="product-thumbnail flex-shrink-0 w-20 h-20 opacity-60 hover:opacity-100 rounded-lg overflow-hidden transition-opacity cursor-pointer border-0 outline-none" data-image-src="{{ image | url }}">
                                            <img src="{{ image | url }}" alt="{{ product.title }} thumbnail {{ loop.index }}" class="w-full h-full object-cover">
                                        </button>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Product Info Container -->
            <div class="w-full md:w-1/2 md:h-[100%] flex flex-col gap-8 md:order-2">
                <!-- Title Container - Hidden on mobile/tablet, shown on desktop -->
                <div class="w-full hidden md:block">
                    <h1 class="text-xl md:text-3xl font-bold text-primary-evergreen">{{ product.title }}</h1>
                </div>
                
                <!-- Package Container -->
                {% if product.package %}
                    <div class="bg-white/40 rounded-2xl p-4">
                        <h3 class="text-lg font-semibold text-primary-evergreen mb-2">Опаковка</h3>
                        <p class="text-primary-volcanic">{{ product.package }}</p>
                    </div>
                {% endif %}
                
                <!-- Sustavki (Ingredients) Container -->
                {% if product.sustavki and product.sustavki.length > 0 %}
                    <div class="bg-white/40 rounded-2xl p-4">
                        <h3 class="text-lg font-semibold text-primary-evergreen mb-2">Съставки</h3>
                        <div class="text-primary-volcanic space-y-1">
                            {% for sustavka in product.sustavki %}
                                <p>- {{ sustavka }}</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Benefits Container -->
                {% if product.benefits and product.benefits.length > 0 %}
                    <div class="bg-white/40 rounded-2xl p-4 ">
                        <h3 class="text-lg font-semibold text-primary-evergreen mb-4">Ползи</h3>
                        <div class="flex flex-wrap gap-2">
                            {% for benefit in product.benefits %}
                                <div class="flex items-center gap-2 bg-white/80 rounded-full px-3 py-1.5">
                                    <img src="{{ benefit.benefit_icon | url }}" alt="{{ benefit.benefit_name }}" class="w-4 h-4 object-contain flex-shrink-0">
                                    <span class="text-primary-volcanic text-sm">{{ benefit.benefit_name }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Order Button -->
                <button type="button" id="open-order-modal" class="bg-green-700 hover:bg-green-800 text-white w-full text-center rounded-2xl py-3 font-semibold transition-colors">
                    Поръчай
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Описание Section -->
{% if product.long_description %}
<section class="py-6 mt-6 bg-primary-sand/30">
    <div class="max-w-7xl w-full mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-primary-evergreen mb-6 flex items-center gap-3">
            <img src="{{ '/assets/images/description.png' | url }}" alt="Описание" class="w-8 h-8 object-contain">
            <span>Описание</span>
        </h2>
        <div class="bg-white/60 rounded-2xl p-6 md:p-8">
            <div class="prose prose-lg max-w-none">
                <p class="text-primary-deepsea leading-relaxed text-base md:text-lg">
                    {{ product.long_description }}
                </p>
            </div>
        </div>
    </div>
</section>
{% endif %}

{% if product.used_for or product.how_to_use %}
<section class="py-6 bg-primary-sand/30">
    <div class="max-w-7xl w-full mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-primary-evergreen mb-6 flex items-center gap-3">
            <img src="{{ '/assets/images/how-use.png' | url }}" alt="Как да използваме" class="w-8 h-8 object-contain">
            <span>Как да използваме</span>
        </h2>
        <div class="bg-white/50 rounded-2xl p-6 md:p-8 space-y-3 shadow-sm">
            {% if product.used_for %}
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-primary-evergreen">За какво помага</h3>
                    <p class="text-primary-deepsea text-base md:text-lg leading-relaxed">{{ product.used_for }}</p>
                </div>
            {% endif %}
            {% if product.how_to_use %}
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-primary-evergreen">Начин на употреба</h3>
                    <p class="text-primary-deepsea text-base md:text-lg leading-relaxed">{{ product.how_to_use }}</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}

{% if product.dosage or product.contraindications or product.storage %}
<section class="py-6 bg-primary-sand/30">
    <div class="max-w-7xl w-full mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold text-primary-evergreen mb-6 flex items-center gap-3">
            <img src="{{ '/assets/images/important.png' | url }}" alt="Важна информация" class="w-8 h-8 object-contain">
            <span>Важна информация</span>
        </h2>
        <div class="bg-white/50 rounded-2xl p-6 md:p-8 space-y-3 shadow-sm">
            {% if product.dosage %}
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-primary-evergreen">Дозировка</h3>
                    <p class="text-primary-deepsea text-base md:text-lg leading-relaxed">{{ product.dosage }}</p>
                </div>
            {% endif %}
            {% if product.contraindications %}
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-primary-evergreen">Противопоказания</h3>
                    <p class="text-primary-deepsea text-base md:text-lg leading-relaxed">{{ product.contraindications }}</p>
                </div>
            {% endif %}
            {% if product.storage %}
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-primary-evergreen">Съхранение</h3>
                    <p class="text-primary-deepsea text-base md:text-lg leading-relaxed">{{ product.storage }}</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}

{% if relatedProducts and relatedProducts.length > 0 %}
<section class="py-6  bg-primary-sand/30">
    <div class="max-w-7xl w-full mx-auto px-4 ">
        <div class="flex items-center gap-3 mb-6">
            <span class="flex items-center justify-center w-10 h-10 ">
                <img src="{{ '/assets/images/products.png' | url }}" alt="Продукти" class="w-6 h-6 object-contain">
            </span>
            <h2 class="text-2xl md:text-3xl font-bold text-primary-evergreen">Разгледай други продукти</h2>
        </div>
        <div class="-mx-4 overflow-x-auto pb-8 md:mx-0 xl:overflow-visible xl:pb-0 custom-scrollbar no-scrollbar">
            <div class="flex gap-6 px-4 xl:px-0 xl:grid xl:grid-cols-4 xl:gap-6 drag-scroll">
                {% for item in relatedProducts %}
                    <div class="group relative flex-shrink-0">
                        <div class="home-product-card h-full p-2 bg-white rounded-3xl relative flex flex-col w-[240px] xl:w-full transition-all duration-300 shadow-md">
                            {% if item.images and item.images.length > 0 %}
                                <div class="home-product-image flex items-center justify-center overflow-hidden">
                                    <img src="{{ item.images[0] | url }}" alt="{{ item.title }}">
                                </div>
                            {% endif %}
                            <div class="pt-2 flex flex-col gap-4 flex-grow">
                                <div class="flex flex-col gap-2 justify-between">
                                    <h3 class="text-md font-bold">{{ item.title }}</h3>
                                    {% if item.short_description %}
                                        <p class="text-sm">{{ item.short_description }}</p>
                                    {% endif %}
                                </div>
                                <div class="product-card-benefits">
                                    {% if item.benefits and item.benefits.length > 0 %}
                                        <div class="benefit-icons flex flex-row gap-2">
                                            {% for benefit in item.benefits %}
                                                <div class="relative group benefit-icon-wrapper">
                                                    <img src="{{ benefit.benefit_icon | url }}" alt="{{ benefit.benefit_name }}" class="bg-primary-ceramic rounded-full h-8 w-8 object-contain">
                                                    <span class="benefit-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max px-2 py-1 bg-primary-deepsea text-white text-xs rounded opacity-0 invisible transition-opacity duration-300 pointer-events-none">
                                                        {{ benefit.benefit_name }}
                                                    </span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="mt-2 product-card-button flex flex-col flex-grow">
                                    <a href="{{ ('/produkti/' ~ item.meta_title ~ '/') | url }}" class="block text-center btn-primary font-semibold rounded-full py-2 mt-auto hover:bg-primary-evergreen/90 transition-colors">Виж продукта</a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Order Modal -->
<div id="order-modal" class="fixed inset-0 z-[99999] hidden overflow-y-auto">
    <div class="absolute inset-0 bg-black/60 z-[1]" data-modal-overlay></div>
    <div class="relative z-[2] flex items-center justify-center min-h-screen py-4 md:py-16 px-4">
        <div class="order-modal w-full max-w-xl bg-white rounded-3xl shadow-[0_30px_80px_rgba(0,0,0,0.2)] p-6 md:p-8 lg:p-10 relative z-[3]">
            <button type="button" class="absolute top-4 right-4 text-primary-volcanic/60 hover:text-primary-volcanic transition-colors text-2xl" data-close-modal>
                <span class="sr-only">Затвори</span>
                ✕
            </button>
            
            <div class="space-y-6">
                <div class="text-center">
                    <div class="flex items-center justify-center gap-3 mb-2">
                        <h3 class="text-2xl md:text-3xl font-bold text-primary-evergreen">Поръчай до офис на еконт</h3>
                        <img src="{{ '/assets/images/ekont-logo.png' | url }}" alt="Еконт" class="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover">
                    </div>
                    <p class="text-primary-deepsea text-base">{{ product.title }}</p>
                </div>

                <form id="order-form" action="https://api.web3forms.com/submit" method="POST" class="space-y-5">
                    <input type="hidden" name="access_key" value="4eabcc47-f892-4a07-93b7-a0b089cb73d5">
                    <input type="hidden" name="subject" value="Нова поръчка: {{ product.title }}">
                    <input type="hidden" name="redirect" value="{{ '/blagodarya/' | url }}">
                    <input type="hidden" name="product_name" value="{{ product.title }}">
                    <input type="checkbox" name="botcheck" class="hidden" tabindex="-1" autocomplete="off">

                    <!-- Full Name -->
                    <div>
                        <label for="order-name" class="block text-sm font-semibold text-primary-deepsea mb-2">Име и фамилия *</label>
                        <input type="text" id="order-name" required class="w-full rounded-2xl border-0 bg-primary-sand/30 px-4 py-3 text-primary-volcanic placeholder:text-primary-dune/60 focus:outline-none focus:ring-2 focus:ring-primary-evergreen/50 transition" placeholder="Въведете име и фамилия">
                    </div>

                    <!-- Phone Number -->
                    <div>
                        <label for="order-phone" class="block text-sm font-semibold text-primary-deepsea mb-2">Телефон *</label>
                        <input type="tel" id="order-phone" required class="w-full rounded-2xl border-0 bg-primary-sand/30 px-4 py-3 text-primary-volcanic placeholder:text-primary-dune/60 focus:outline-none focus:ring-2 focus:ring-primary-evergreen/50 transition" placeholder="0888 888 888">
                    </div>

                    <!-- Quantity -->
                    <div>
                        <label for="order-quantity" class="block text-sm font-semibold text-primary-deepsea mb-2">Количество *</label>
                        <div class="flex items-center gap-3">
                            <button type="button" id="decrease-quantity" class="w-10 h-10 rounded-full bg-primary-sand/60 hover:bg-primary-sand/80 text-primary-evergreen font-bold text-lg transition-colors flex items-center justify-center">−</button>
                            <input type="number" id="order-quantity" value="1" min="1" required readonly class="w-20 text-center rounded-xl border-0 bg-primary-sand/30 px-4 py-3 text-primary-volcanic font-semibold focus:outline-none">
                            <button type="button" id="increase-quantity" class="w-10 h-10 rounded-full bg-primary-sand/60 hover:bg-primary-sand/80 text-primary-evergreen font-bold text-lg transition-colors flex items-center justify-center">+</button>
                        </div>
                    </div>

                    <!-- City -->
                    <div>
                        <label for="order-city" class="block text-sm font-semibold text-primary-deepsea mb-2">Град *</label>
                        <input type="text" id="order-city" required autocomplete="nope" data-lpignore="true" data-form-type="other" data-autocomplete-off="true" data-prevent-autofill="true" readonly class="w-full rounded-2xl border-0 bg-primary-sand/30 px-4 py-3 text-primary-volcanic placeholder:text-primary-dune/60 focus:outline-none focus:ring-2 focus:ring-primary-evergreen/50 transition" placeholder="Въведете град">
                        <div id="city-suggestions" class="mt-2 hidden max-h-48 overflow-y-auto border border-gray-200 rounded-xl bg-white shadow-lg"></div>
                    </div>

                    <!-- Office -->
                    <div>
                        <label for="order-office" class="block text-sm font-semibold text-primary-deepsea mb-2">Офис на еконт *</label>
                        <input type="text" id="order-office" required autocomplete="nope" data-lpignore="true" data-form-type="other" data-autocomplete-off="true" data-prevent-autofill="true" readonly class="w-full rounded-2xl border-0 bg-primary-sand/30 px-4 py-3 text-primary-volcanic placeholder:text-primary-dune/60 focus:outline-none focus:ring-2 focus:ring-primary-evergreen/50 transition" placeholder="Изберете офис">
                        <div id="office-suggestions" class="mt-2 hidden max-h-48 overflow-y-auto border border-gray-200 rounded-xl bg-white shadow-lg"></div>
                    </div>

                    <!-- Price Display -->
                    <div class="bg-primary-sand/30 rounded-2xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-primary-deepsea font-semibold">Единична цена:</span>
                            <span class="text-primary-evergreen font-bold" id="unit-price">{{ product.price }} €</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-primary-deepsea font-semibold">Обща сума:</span>
                            <span class="text-primary-evergreen font-bold text-xl" id="total-price">{{ product.price }} €</span>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-green-700 hover:bg-green-800 text-white rounded-2xl py-3 font-semibold transition-colors">
                        Изпрати поръчка
                    </button>

                    <p class="text-sm text-primary-dune/80 text-center" id="order-form-result"></p>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    #order-modal {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .order-modal {
        max-height: 80vh;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }

    @media (min-width: 768px) {
        .order-modal {
            max-height: 90vh;
        }
    }

    .order-modal::-webkit-scrollbar {
        width: 6px;
    }

    .order-modal::-webkit-scrollbar-track {
        background: transparent;
    }

    .order-modal::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }
</style>

<script src="{{ '/assets/js/product-carousel.js' | url }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const openButton = document.getElementById('open-order-modal');
        const modal = document.getElementById('order-modal');
        const quantityInput = document.getElementById('order-quantity');
        const decreaseBtn = document.getElementById('decrease-quantity');
        const increaseBtn = document.getElementById('increase-quantity');
        const unitPriceEl = document.getElementById('unit-price');
        const totalPriceEl = document.getElementById('total-price');
        const cityInput = document.getElementById('order-city');
        const officeInput = document.getElementById('order-office');
        const citySuggestions = document.getElementById('city-suggestions');
        const officeSuggestions = document.getElementById('office-suggestions');
        const orderForm = document.getElementById('order-form');

        if (!openButton || !modal) {
            return;
        }

        // Load Ekont offices data
        let ekontOffices = [];
        fetch('{{ "/assets/data/ekontOffices.json" | url }}')
            .then(res => res.json())
            .then(data => {
                ekontOffices = data;
            })
            .catch(err => console.error('Error loading Ekont offices:', err));

        const productPrice = parseFloat('{{ product.price }}' || '10');
        let selectedCity = '';
        let selectedOffice = '';
        let officeAddressValue = '';

        // Update price display
        function updatePrice() {
            const quantity = parseInt(quantityInput.value) || 1;
            const total = (productPrice * quantity).toFixed(2);
            unitPriceEl.textContent = productPrice.toFixed(2) + ' €';
            totalPriceEl.textContent = total + ' €';
            
            // Update hidden form field
            const totalInput = document.createElement('input');
            totalInput.type = 'hidden';
            totalInput.name = 'total_price';
            totalInput.value = total;
            if (document.querySelector('input[name="total_price"]')) {
                document.querySelector('input[name="total_price"]').value = total;
            } else {
                orderForm.appendChild(totalInput);
            }
        }

        // Quantity controls
        if (decreaseBtn && quantityInput) {
            decreaseBtn.addEventListener('click', () => {
                const current = parseInt(quantityInput.value) || 1;
                if (current > 1) {
                    quantityInput.value = current - 1;
                    updatePrice();
                }
            });
        }

        if (increaseBtn && quantityInput) {
            increaseBtn.addEventListener('click', () => {
                const current = parseInt(quantityInput.value) || 1;
                quantityInput.value = current + 1;
                updatePrice();
            });
        }

        // City filtering and dropdown
        if (cityInput && citySuggestions) {
            function showCityDropdown(searchTerm = '') {
                if (ekontOffices.length === 0) return;
                
                const term = searchTerm.toLowerCase();
                const filteredCities = term.length > 0 
                    ? ekontOffices.filter(city => city.city.toLowerCase().includes(term))
                    : ekontOffices;

                if (filteredCities.length > 0) {
                    citySuggestions.innerHTML = filteredCities.map(city => 
                        `<div class="p-3 hover:bg-primary-sand/40 cursor-pointer border-b border-primary-sand/30 last:border-b-0" data-city="${city.city}">${city.city}</div>`
                    ).join('');
                    citySuggestions.classList.remove('hidden');
                } else {
                    citySuggestions.classList.add('hidden');
                }
            }

            // Show dropdown on click/focus
            cityInput.addEventListener('click', () => {
                // Remove readonly if present
                cityInput.removeAttribute('readonly');
                // Clear autofilled value if not selected
                if (!selectedCity && cityInput.value) {
                    cityInput.value = '';
                }
                if (ekontOffices.length > 0) {
                    showCityDropdown(cityInput.value);
                }
            });

            cityInput.addEventListener('focus', () => {
                // Remove readonly and clear any autofilled value
                cityInput.removeAttribute('readonly');
                if (!selectedCity && cityInput.value) {
                    cityInput.value = '';
                }
                if (ekontOffices.length > 0) {
                    showCityDropdown(cityInput.value);
                }
            });

            // Filter while typing
            cityInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                if (searchTerm.length === 0) {
                    officeInput.value = '';
                    officeSuggestions.classList.add('hidden');
                    selectedCity = '';
                    showCityDropdown('');
                    return;
                }
                showCityDropdown(searchTerm);
            });

            // Handle city selection
            citySuggestions.addEventListener('click', (e) => {
                const item = e.target.closest('[data-city]');
                if (item) {
                    selectedCity = item.dataset.city;
                    cityInput.value = selectedCity;
                    citySuggestions.classList.add('hidden');
                    officeInput.value = '';
                    selectedOffice = '';
                    // Clear office address if city changes
                    officeAddressValue = '';
                    officeInput.removeAttribute('data-office-address');
                    officeInput.focus();
                    // Focus will trigger the office dropdown to show
                }
            });

            // Prevent autofill for city field
            cityInput.addEventListener('change', () => {
                if (cityInput.value && !selectedCity) {
                    cityInput.value = '';
                }
            });

            // Monitor for autofill and clear it
            let cityInputInterval = setInterval(() => {
                if (cityInput.value && !selectedCity && cityInput === document.activeElement) {
                    // Value was autofilled, clear it
                    cityInput.value = '';
                }
            }, 100);

            setTimeout(() => clearInterval(cityInputInterval), 5000);

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!cityInput.contains(e.target) && !citySuggestions.contains(e.target)) {
                    citySuggestions.classList.add('hidden');
                }
            });
        }

        // Office filtering and dropdown
        if (officeInput && officeSuggestions) {
            function showOfficeDropdown(searchTerm = '') {
                if (!selectedCity || ekontOffices.length === 0) {
                    officeSuggestions.classList.add('hidden');
                    return;
                }

                const cityData = ekontOffices.find(c => c.city === selectedCity);
                if (!cityData || !cityData.offices || cityData.offices.length === 0) {
                    officeSuggestions.classList.add('hidden');
                    return;
                }

                const term = searchTerm.toLowerCase();
                const filteredOffices = term.length > 0
                    ? cityData.offices.filter(office => 
                        office.name.toLowerCase().includes(term) ||
                        office.address.toLowerCase().includes(term)
                      )
                    : cityData.offices;

                if (filteredOffices.length > 0) {
                    officeSuggestions.innerHTML = filteredOffices.map(office => 
                        `<div class="p-3 hover:bg-primary-sand/40 cursor-pointer border-b border-primary-sand/30 last:border-b-0" data-office="${office.name}" data-address="${office.address}">
                            <div class="font-semibold text-primary-evergreen">${office.name}</div>
                            <div class="text-sm text-primary-dune">${office.address}</div>
                        </div>`
                    ).join('');
                    officeSuggestions.classList.remove('hidden');
                } else {
                    officeSuggestions.classList.add('hidden');
                }
            }

            // Show dropdown on click/focus
            officeInput.addEventListener('click', () => {
                // Remove readonly if present
                officeInput.removeAttribute('readonly');
                // Clear autofilled value if not selected
                if (!selectedOffice && officeInput.value) {
                    officeInput.value = '';
                    officeAddressValue = '';
                }
                if (selectedCity && ekontOffices.length > 0) {
                    showOfficeDropdown(officeInput.value);
                }
            });

            officeInput.addEventListener('focus', () => {
                // Remove readonly and clear any autofilled value
                officeInput.removeAttribute('readonly');
                if (!selectedOffice && officeInput.value) {
                    officeInput.value = '';
                    officeAddressValue = '';
                    officeInput.removeAttribute('data-office-address');
                }
                if (selectedCity && ekontOffices.length > 0) {
                    showOfficeDropdown(officeInput.value);
                }
            });

            // Filter while typing
            officeInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                showOfficeDropdown(searchTerm);
            });

            // Handle office selection
            officeSuggestions.addEventListener('click', (e) => {
                const item = e.target.closest('[data-office]');
                if (item) {
                    selectedOffice = item.dataset.office;
                    officeAddressValue = item.dataset.address;
                    officeInput.value = selectedOffice;
                    // Store address in data attribute for easy access
                    officeInput.setAttribute('data-office-address', item.dataset.address);
                    officeSuggestions.classList.add('hidden');
                }
            });

            // Prevent autofill for office field
            officeInput.addEventListener('change', () => {
                if (officeInput.value && !selectedOffice) {
                    officeInput.value = '';
                }
            });

            // Monitor for autofill and clear it
            let officeInputInterval = setInterval(() => {
                if (officeInput.value && !selectedOffice && officeInput === document.activeElement) {
                    // Value was autofilled, clear it
                    officeInput.value = '';
                }
            }, 100);

            setTimeout(() => clearInterval(officeInputInterval), 5000);

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!officeInput.contains(e.target) && !officeSuggestions.contains(e.target)) {
                    officeSuggestions.classList.add('hidden');
                }
            });
        }

        // Modal controls
        const overlay = modal.querySelector('[data-modal-overlay]');
        const closeButtons = modal.querySelectorAll('[data-close-modal]');

        const openModal = () => {
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            updatePrice();
            
            // Clear any autofilled values and set readonly again
            setTimeout(() => {
                if (!selectedCity && cityInput.value) {
                    cityInput.value = '';
                    cityInput.setAttribute('readonly', '');
                }
                
                if (!selectedOffice && officeInput.value) {
                    officeInput.value = '';
                    officeInput.setAttribute('readonly', '');
                    officeAddressValue = '';
                    officeInput.removeAttribute('data-office-address');
                }
            }, 100);
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            // Reset form
            orderForm.reset();
            quantityInput.value = 1;
            selectedCity = '';
            selectedOffice = '';
            officeAddressValue = '';
            if (officeInput) {
                officeInput.removeAttribute('data-office-address');
            }
            citySuggestions.classList.add('hidden');
            officeSuggestions.classList.add('hidden');
            updatePrice();
        };

        openButton.addEventListener('click', openModal);

        closeButtons.forEach((button) => {
            button.addEventListener('click', closeModal);
        });

        if (overlay) {
            overlay.addEventListener('click', closeModal);
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // Form submission
        if (orderForm) {
            orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = orderForm.querySelector('button[type="submit"]');
                const resultDiv = document.getElementById('order-form-result');
                
                submitButton.disabled = true;
                submitButton.textContent = 'Изпраща...';

                const quantity = parseInt(quantityInput.value) || 1;
                const totalPrice = (productPrice * quantity).toFixed(2);
                const nameValue = document.getElementById('order-name').value;
                const phoneValue = document.getElementById('order-phone').value;
                const cityValue = cityInput.value;
                const officeValue = officeInput.value;
                // Get office address from variable or data attribute
                const officeAddress = (typeof officeAddressValue !== 'undefined' && officeAddressValue) || officeInput.getAttribute('data-office-address') || '';
                
                // Build email message with all order details
                const message = `Нова поръчка:

Продукт: {{ product.title }}
Количество: ${quantity}
Единична цена: ${productPrice.toFixed(2)} €
Обща сума: ${totalPrice} €

Данни за доставка:
Име: ${nameValue}
Телефон: ${phoneValue}
Град: ${cityValue}
Офис на Еконт: ${officeValue}${officeAddress ? '\nАдрес на офис: ' + officeAddress : ''}`;
                
                // Build FormData manually with only essential fields
                const formData = new FormData();
                formData.append('access_key', '4eabcc47-f892-4a07-93b7-a0b089cb73d5');
                formData.append('subject', 'Нова поръчка: {{ product.title }}');
                formData.append('redirect', '{{ "/blagodarya/" | url }}');
                formData.append('botcheck', '');
                formData.append('message', message);

                try {
                    const response = await fetch('https://api.web3forms.com/submit', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        resultDiv.textContent = 'Поръчката е изпратена успешно!';
                        resultDiv.className = 'text-sm text-green-600 text-center';
                        setTimeout(() => {
                            window.location.href = '{{ "/blagodarya/" | url }}';
                        }, 2000);
                    } else {
                        resultDiv.textContent = 'Грешка при изпращане. Моля опитайте отново.';
                        resultDiv.className = 'text-sm text-red-600 text-center';
                        submitButton.disabled = false;
                        submitButton.textContent = 'Изпрати поръчка';
                    }
                } catch (error) {
                    resultDiv.textContent = 'Грешка при изпращане. Моля опитайте отново.';
                    resultDiv.className = 'text-sm text-red-600 text-center';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Изпрати поръчка';
                }
            });
        }

        // Initialize price
        updatePrice();
    });
</script>
